<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Заказы</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --hint: #888888;
      --accent: #0088cc;
      --card: #f8f9fa;
      --wb: #7b2cbf;
      --ozon: #005bff;
      --avito: #00cc66;
      --ym: #ffcc00;
      --aliexpress: #ff6600;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1621;
        --text: #e0e0e0;
        --hint: #9ca3af;
        --card: #1a2332;
      }
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      padding: 16px;
    }

    .container { max-width: 600px; margin: 0 auto; }

    header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
    }

    .back-btn {
      background: none;
      border: none;
      font-size: 32px;
      color: var(--accent);
      cursor: pointer;
      padding: 8px;
      margin-right: 16px;
    }

    .progress {
      flex: 1;
      height: 6px;
      background: rgba(0,0,0,0.08);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.4s ease;
    }

    h1 { font-size: 26px; font-weight: 600; margin-bottom: 8px; text-align: center; }

    .step-title {
      font-size: 22px;
      font-weight: 600;
      margin: 24px 0 20px;
      text-align: center;
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      font-size: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      user-select: none;
    }

    .card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .color-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    input, textarea {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      border-radius: 16px;
      border: 1px solid #ccc;
      background: var(--card);
      color: var(--text);
      margin: 12px 0;
    }

    #status {
      margin: 24px 0;
      color: var(--hint);
      font-size: 15px;
      text-align: center;
    }

    #add-form { display: none; }

    #orders-list { margin-top: 32px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="back-btn" onclick="goBack()" id="backBtn" style="visibility:hidden;">←</button>
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </header>

    <h1>Мои заказы</h1>

    <div class="card" onclick="startAddOrder()" style="justify-content:center; font-size:22px; font-weight:600;">
      ➕ Добавить заказ
    </div>

    <div id="add-form">
      <div class="step-title" id="stepTitle"></div>
      <div id="currentStep"></div>
      <div id="status"></div>
    </div>

    <div class="card" onclick="getOrders()" style="justify-content:center; font-weight:600; margin-top:32px;">
      Обновить список
    </div>

    <div id="orders-list" style="margin-top:32px;"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    function applyTheme() {
      document.body.style.background = tg.backgroundColor;
      document.body.style.color = tg.textColor;
    }
    applyTheme();
    tg.onEvent('themeChanged', applyTheme);

    let orderData = {};
    let currentStep = 0;
    let quantity = 1;

    const steps = [
      {
        title: 'Магазин',
        render: () => {
          const shops = [
            { name: 'Wildberries', color: 'var(--wb-color)' },
            { name: 'Ozon', color: 'var(--ozon-color)' },
            { name: 'Avito', color: 'var(--avito-color)' },
            { name: 'Яндекс Маркет', color: 'var(--ym-color)' },
            { name: 'Aliexpress', color: 'var(--aliexpress-color)' },
            { name: 'Другое', color: '#888888' }
          ];
          return shops.map(s => `
            <div class="card" onclick="selectValue('shop', '${s.name}')">
              <div class="color-dot" style="background:${s.color}"></div>
              ${s.name}
            </div>
          `).join('');
        }
      },

      {
        title: 'Номер заказа',
        render: () => {
          if (orderData.shop === 'Wildberries') {
            orderData.orderNumber = '';
            nextStep();
            return '';
          }
          return `
            <input type="text" id="orderNum" placeholder="Номер заказа" value="${orderData.orderNumber || ''}" autofocus>
            <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
          `;
        },
        save: () => {
          if (orderData.shop !== 'Wildberries') {
            orderData.orderNumber = document.getElementById('orderNum')?.value.trim() || '';
          }
        }
      },

      {
        title: 'Аккаунт',
        render: () => {
          const accs = ['Артем','Лиза','Роберт','Максим','Мама','Миша','Кунак','Другое'];
          let html = accs.map(a => `
            <div class="card" onclick="selectValue('account', '${a}')">${a}</div>
          `).join('');
          if (orderData.account === 'Другое') {
            html += `
              <input type="text" id="accOther" placeholder="Введите аккаунт" value="${orderData.accountOther || ''}" autofocus>
              <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
            `;
          }
          return html;
        },
        save: () => {
          if (orderData.account === 'Другое') {
            orderData.account = document.getElementById('accOther')?.value.trim() || 'Другое';
          }
        }
      },

      {
        title: 'Дата заказа',
        render: () => {
          const today = new Date().toISOString().split('T')[0];
          const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
          return `
            <div class="card" onclick="selectValue('date', '${today}')">Сегодня</div>
            <div class="card" onclick="selectValue('date', '${yesterday}')">Вчера</div>
            <div class="card" onclick="selectValue('date', 'other')">Другое (выбрать дату)</div>
          `;
        }
      },

      {
        title: 'Позиция (товар)',
        render: () => `
          <input type="text" id="position" placeholder="Название товара" value="${orderData.position || ''}" autofocus>
          <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
        `,
        save: () => orderData.position = document.getElementById('position')?.value.trim() || ''
      },

      {
        title: 'Адрес ПВЗ',
        render: () => {
          let addrs = [];
          if (orderData.shop === 'Wildberries') {
            addrs = [
              '1 Грайвороновский проезд 3',
              'Проспект Буденного 51к1',
              'Красноказарменная 15к1',
              'Профсоюзная 96',
              'Люблинская 51',
              'Севастопольский проспект 7/6к1',
              'Другое'
            ];
          } else if (orderData.shop === 'Ozon') {
            addrs = ['Пролетарский 2А', 'Другое'];
          } else {
            addrs = ['Другое'];
          }

          let html = '';
          addrs.forEach(a => {
            html += `<div class="card" onclick="selectValue('pvz', '${a}')">${a}</div>`;
          });
          if (orderData.pvz === 'Другое') {
            html += `
              <input type="text" id="pvzOther" placeholder="Введите адрес" value="${orderData.pvzOther || ''}" autofocus>
              <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
            `;
          }
          return html;
        },
        save: () => {
          if (orderData.pvz === 'Другое') {
            orderData.pvz = document.getElementById('pvzOther')?.value.trim() || 'Другое';
          }
        }
      },

      {
        title: 'Оплата',
        render: () => {
          const opts = ['Оплачен', 'При получении'];
          return opts.map(o => `
            <div class="card" onclick="selectValue('payment', '${o}')">${o}</div>
          `).join('');
        }
      },

      {
        title: 'Цена за 1 шт (₽)',
        render: () => `
          <input type="number" id="price" min="1" step="0.01" placeholder="Цена" value="${orderData.price || ''}" autofocus>
          <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
        `,
        save: () => orderData.price = parseFloat(document.getElementById('price')?.value) || 0
      },

      {
        title: 'Количество штук',
        render: () => `
          <input type="number" id="quantity" min="1" placeholder="Количество" value="${quantity}" autofocus>
          <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
        `,
        save: () => quantity = parseInt(document.getElementById('quantity')?.value || 1)
      },

      {
        title: 'Подтвердить',
        render: () => `
          <div style="padding:20px; background:var(--card); border-radius:16px; margin-bottom:24px;">
            <p><b>Магазин:</b> ${orderData.shop}</p>
            <p><b>Аккаунт:</b> ${orderData.account}</p>
            <p><b>Дата:</b> ${orderData.date}</p>
            <p><b>Товар:</b> ${orderData.position}</p>
            <p><b>ПВЗ:</b> ${orderData.pvz}</p>
            <p><b>Оплата:</b> ${orderData.payment}</p>
            <p><b>Цена за шт:</b> ${orderData.price} ₽</p>
            <p><b>Количество:</b> ${quantity} шт</p>
            <p><b>Сумма за строку:</b> ${(orderData.price || 0).toFixed(2)} ₽</p>
          </div>
          <div class="card" onclick="addOrderToSheets()" style="justify-content:center; font-weight:600; font-size:20px;">
            Добавить в таблицу
          </div>
        `
      }
    ];

    function startAddOrder() {
      orderData = {};
      currentStep = 0;
      quantity = 1;
      document.getElementById('add-form').style.display = 'block';
      renderStep();
      updateProgress();
      document.getElementById('backBtn').style.visibility = 'hidden';
    }

    function renderStep() {
      const step = steps[currentStep];
      document.getElementById('stepTitle').textContent = step.title;
      document.getElementById('currentStep').innerHTML = step.render ? step.render() : '';
      document.getElementById('backBtn').style.visibility = currentStep > 0 ? 'visible' : 'hidden';

      // Автофокус на input, если есть
      const input = document.querySelector('input[autofocus]');
      if (input) {
        setTimeout(() => input.focus(), 100);
      }
    }

    function updateProgress() {
      const percent = ((currentStep + 1) / steps.length) * 100;
      document.getElementById('progressBar').style.width = percent + '%';
    }

    function goBack() {
      if (currentStep > 0) {
        currentStep--;
        renderStep();
        updateProgress();
      }
    }

    window.selectValue = function(field, value) {
      orderData[field] = value;
      currentStep++;
      renderStep();
      updateProgress();
    };

    function nextStep() {
      const step = steps[currentStep];
      if (step.save) step.save();

      currentStep++;
      renderStep();
      updateProgress();
    }

    async function addOrderToSheets() {
      const status = document.getElementById('status');
      status.textContent = `Добавление ${quantity} строк...`;
      document.querySelector('.card[onclick="addOrderToSheets()"]').style.pointerEvents = 'none';

      try {
        const price = parseFloat(orderData.price) || 0;
        const singleSum = price.toFixed(2);

        const rows = [];
        for (let i = 0; i < quantity; i++) {
          rows.push({
            Магазин: orderData.shop,
            'Номер заказа': orderData.orderNumber || '',
            Аккаунт: orderData.account,
            'Дата заказа': orderData.date,
            Позиция: orderData.position,
            'Адрес ПВЗ': orderData.pvz,
            Статус: 'В пути',
            Оплата: orderData.payment,
            'Цена товара': price,
            Количество: 1,
            Сумма: singleSum,
          });
        }

        const res = await fetch('/api/add-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            initData: tg.initData,
            rows
          })
        });

        if (!res.ok) throw new Error(`Сервер: ${res.status}`);

        const result = await res.json();
        status.textContent = `Успешно добавлено ${result.count} строк!`;
        document.getElementById('add-form').style.display = 'none';
        getOrders();
      } catch (err) {
        console.error(err);
        status.textContent = 'Ошибка: ' + err.message;
      } finally {
        document.querySelector('.card[onclick="addOrderToSheets()"]').style.pointerEvents = 'auto';
      }
    }

    async function getOrders() {
      const list = document.getElementById('orders-list');
      list.innerHTML = '<p style="text-align:center; color:var(--hint);">Загрузка...</p>';

      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: tg.initData })
        });

        if (!res.ok) throw new Error('Ошибка загрузки');

        const data = await res.json();

        if (!data.orders || data.orders.length === 0) {
          list.innerHTML = '<p style="text-align:center; color:var(--hint);">Заказов пока нет</p>';
          return;
        }

        let html = '';
        data.orders.forEach(order => {
          html += `
            <div class="card">
              <div>
                <strong>${order['Дата заказа'] || '—'}</strong><br>
                ${order.Позиция || '—'}<br>
                Сумма: ${order.Сумма || '—'} ₽
              </div>
            </div>
          `;
        });
        list.innerHTML = html;
      } catch (err) {
        list.innerHTML = '<p style="color:red; text-align:center;">Ошибка загрузки</p>';
      }
    }
  </script>
</body>
</html>
