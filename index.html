<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Заказы</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --hint: #888888;
      --accent: #0088cc;
      --card: #f8f9fa;
      --wb: #7b2cbf;
      --ozon: #005bff;
      --avito: #00cc66;
      --ym: #ffcc00;
      --aliexpress: #ff6600;
      --paid: #00cc66;
      --unpaid: #ff6600;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1621;
        --text: #e0e0e0;
        --hint: #9ca3af;
        --card: #1a2332;
        --paid: #00cc66;
        --unpaid: #ff6600;
      }
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      padding: 16px;
      padding-bottom: 120px;
    }

    .container { max-width: 600px; margin: 0 auto; }

    header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
    }

    .back-btn {
      background: none;
      border: none;
      font-size: 32px;
      color: var(--accent);
      cursor: pointer;
      padding: 8px;
      margin-right: 16px;
    }

    .progress {
      flex: 1;
      height: 6px;
      background: rgba(0,0,0,0.08);
      border-radius: 3px;
      overflow: hidden;
      display: none; /* Скрываем на всех страницах кроме формы добавления */
    }

    .progress-bar {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.4s ease;
    }

    .step-title {
      font-size: 22px;
      font-weight: 600;
      margin: 0 0 20px;
      text-align: center;
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      font-size: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      user-select: none;
    }

    .card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .status-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-count {
      background: var(--accent);
      color: white;
      border-radius: 12px;
      padding: 4px 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .color-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    input, textarea {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      border-radius: 16px;
      border: 1px solid #ccc;
      background: var(--card);
      color: var(--text);
      margin: 12px 0;
    }

    #status {
      margin: 24px 0;
      color: var(--hint);
      font-size: 15px;
      text-align: center;
    }

    #add-form { display: none; }

    #orders-list { margin-top: 0; display: none; }

    #analytics-section { 
      margin-top: 0; 
      display: none; 
    }

    .analytics-main-card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      user-select: none;
    }

    .analytics-main-card.expanded {
      margin-bottom: 0;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .analytics-main-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .analytics-main-amount {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      text-align: center;
      margin: 8px 0;
    }

    .analytics-main-subtitle {
      text-align: center;
      color: var(--hint);
      font-size: 16px;
      margin-top: 4px;
    }

    .analytics-details {
      background: var(--card);
      border-radius: 0 0 20px 20px;
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    .analytics-details.expanded {
      padding: 20px;
      max-height: 1000px;
      margin-bottom: 16px;
    }

    .analytics-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .analytics-item:last-child {
      border-bottom: none;
    }

    .analytics-label {
      font-size: 18px;
      color: var(--text);
    }

    .analytics-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent);
    }

    .arrow-icon {
      font-size: 24px;
      color: var(--accent);
      transition: transform 0.3s ease;
    }

    .arrow-icon.expanded {
      transform: rotate(180deg);
    }

    /* Стили для табличной структуры в списках */
    .table-container {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    .table-header {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 20px;
      text-align: center;
    }

    .table-total {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(0,136,204,0.1);
      border-radius: 12px;
    }

    .table-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      align-items: center;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-cell {
      font-size: 18px;
    }

    .table-cell-name {
      font-weight: 500;
    }

    .table-cell-count {
      text-align: center;
      font-weight: 600;
    }

    .table-cell-amount {
      text-align: right;
      font-weight: 600;
      color: var(--accent);
    }

    /* Стили для ПВЗ с подразделами оплаты */
    .pvz-table-container {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    .pvz-header {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pvz-total {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(0,136,204,0.1);
      border-radius: 12px;
    }

    .payment-section {
      margin-bottom: 20px;
    }

    .payment-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payment-paid .payment-header {
      background: rgba(0,204,102,0.1);
      color: var(--paid);
    }

    .payment-unpaid .payment-header {
      background: rgba(255,102,0,0.1);
      color: var(--unpaid);
    }

    .empty-pvz-list {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }

    .empty-pvz-title {
      font-size: 18px;
      color: var(--hint);
      margin-bottom: 12px;
      text-align: center;
    }

    .empty-pvz-item {
      color: var(--hint);
      padding: 8px;
      text-align: center;
      font-style: italic;
    }

    .loading-spinner {
      text-align: center;
      padding: 20px;
      color: var(--hint);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--hint);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .bottom-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    .bottom-btn {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      background: var(--accent);
      color: white;
    }

    .bottom-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="back-btn" onclick="goBack()" id="backBtn" style="visibility:hidden;">←</button>
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </header>

    <div id="add-form">
      <div class="step-title" id="stepTitle"></div>
      <div id="currentStep"></div>
      <div id="status"></div>
    </div>

    <div id="orders-list">
      <div id="status-selection"></div>
      <div id="status-details" style="display:none;"></div>
    </div>

    <div id="analytics-section">
      <div id="analytics-content">
        <!-- Аналитика будет загружена динамически -->
      </div>
    </div>
  </div>

  <div class="bottom-panel">
    <button class="bottom-btn" onclick="startAddOrder()">Новый заказ</button>
    <button class="bottom-btn" onclick="toggleOrders()">Список</button>
    <button class="bottom-btn" onclick="toggleAnalytics()">Аналитика</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    function applyTheme() {
      document.body.style.background = tg.backgroundColor;
      document.body.style.color = tg.textColor;
      document.querySelector('.bottom-panel').style.background = tg.backgroundColor;
    }
    applyTheme();
    tg.onEvent('themeChanged', applyTheme);

    let orderData = {};
    let currentStep = 0;
    let quantity = 1;
    let analyticsExpanded = false;
    let allOrders = [];
    let currentStatusView = '';
    let statusGroupsCache = {};

    const steps = [
      {
        title: 'Магазин',
        render: () => {
          const shops = [
            { name: 'Wildberries', color: 'var(--wb)' },
            { name: 'Ozon', color: 'var(--ozon)' },
            { name: 'Avito', color: 'var(--avito)' },
            { name: 'Яндекс Маркет', color: 'var(--ym)' },
            { name: 'Aliexpress', color: 'var(--aliexpress)' },
            { name: 'Другое', color: '#888888' }
          ];
          return shops.map(s => `
            <div class="card" onclick="selectValue('shop', '${s.name}')">
              <div class="color-dot" style="background:${s.color}"></div>
              ${s.name}
            </div>
          `).join('');
        }
      },

      {
        title: 'Номер заказа',
        render: () => {
          if (orderData.shop === 'Wildberries') {
            orderData.orderNumber = '';
            setTimeout(nextStep, 100);
            return '<p style="color:#888; text-align:center; padding:20px;">Для Wildberries не нужен</p>';
          }
          return `
            <input type="text" id="orderNum" placeholder="Номер заказа" value="${orderData.orderNumber || ''}" autofocus>
            <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
          `;
        },
        save: () => {
          if (orderData.shop !== 'Wildberries') {
            orderData.orderNumber = document.getElementById('orderNum')?.value.trim() || '';
          }
        }
      },

      {
        title: 'Аккаунт',
        render: () => {
          const accs = ['Артем','Лиза','Роберт','Максим','Мама','Миша','Кунак','Другое'];
          let html = accs.map(a => `
            <div class="card" onclick="selectValue('account', '${a}')">${a}</div>
          `).join('');
          if (orderData.account === 'Другое') {
            html += `
              <input type="text" id="accOther" placeholder="Введите аккаунт" value="${orderData.accountOther || ''}" autofocus>
              <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
            `;
          }
          return html;
        },
        save: () => {
          if (orderData.account === 'Другое') {
            orderData.account = document.getElementById('accOther')?.value.trim() || 'Другое';
          }
        }
      },

      {
        title: 'Дата заказа',
        render: () => {
          const today = new Date().toISOString().split('T')[0];
          const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
          return `
            <div class="card" onclick="selectValue('date', '${today}')">Сегодня</div>
            <div class="card" onclick="selectValue('date', '${yesterday}')">Вчера</div>
            <div class="card" onclick="selectValue('date', 'other')">Другое</div>
          `;
        }
      },

      {
        title: 'Позиция (товар)',
        render: () => `
          <input type="text" id="position" placeholder="Название товара" value="${orderData.position || ''}" autofocus>
          <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
        `,
        save: () => orderData.position = document.getElementById('position')?.value.trim() || ''
      },

      {
        title: 'Адрес ПВЗ',
        render: () => {
          let addrs = [];
          if (orderData.shop === 'Wildberries') {
            addrs = [
              '1 Грайвороновский проезд 3',
              'Проспект Буденного 51к1',
              'Красноказарменная 15к1',
              'Профсоюзная 96',
              'Люблинская 51',
              'Севастопольский проспект 7/6к1',
              'Другое'
            ];
          } else if (orderData.shop === 'Ozon') {
            addrs = ['Пролетарский 2А', 'Другое'];
          } else {
            addrs = ['Другое'];
          }

          let html = '';
          addrs.forEach(a => {
            html += `<div class="card" onclick="selectValue('pvz', '${a}')">${a}</div>`;
          });
          if (orderData.pvz === 'Другое') {
            html += `
              <input type="text" id="pvzOther" placeholder="Введите адрес" value="${orderData.pvzOther || ''}" autofocus>
              <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
            `;
          }
          return html;
        },
        save: () => {
          if (orderData.pvz === 'Другое') {
            orderData.pvz = document.getElementById('pvzOther')?.value.trim() || 'Другое';
          }
        }
      },

      {
        title: 'Оплата',
        render: () => {
          const opts = ['Оплачен', 'При получении'];
          return opts.map(o => `
            <div class="card" onclick="selectValue('payment', '${o}')">${o}</div>
          `).join('');
        }
      },

      {
        title: 'Цена за 1 шт (₽)',
        render: () => `
          <input type="number" id="price" min="1" step="0.01" placeholder="Цена" value="${orderData.price || ''}" autofocus>
          <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
        `,
        save: () => orderData.price = parseFloat(document.getElementById('price')?.value) || 0
      },

      {
        title: 'Количество штук',
        render: () => `
          <input type="number" id="quantity" min="1" placeholder="Количество" value="${quantity}" autofocus>
          <div class="card" onclick="nextStep()" style="justify-content:center; margin-top:16px; font-weight:600;">Продолжить</div>
        `,
        save: () => quantity = parseInt(document.getElementById('quantity')?.value || 1)
      },

      {
        title: 'Подтвердить',
        render: () => `
          <div style="padding:20px; background:var(--card); border-radius:16px; margin-bottom:24px;">
            <p><b>Магазин:</b> ${orderData.shop}</p>
            <p><b>Аккаунт:</b> ${orderData.account}</p>
            <p><b>Дата:</b> ${orderData.date}</p>
            <p><b>Товар:</b> ${orderData.position}</p>
            <p><b>ПВЗ:</b> ${orderData.pvz}</p>
            <p><b>Оплата:</b> ${orderData.payment}</p>
            <p><b>Цена за шт:</b> ${orderData.price} ₽</p>
            <p><b>Количество:</b> ${quantity} шт</p>
            <p><b>Сумма за строку:</b> ${(orderData.price || 0).toFixed(2)} ₽</p>
          </div>
          <div class="card" onclick="addOrderToSheets()" style="justify-content:center; font-weight:600; font-size:20px;">
            Добавить в таблицу
          </div>
        `
      }
    ];

    function startAddOrder() {
      orderData = {};
      currentStep = 0;
      quantity = 1;
      document.getElementById('add-form').style.display = 'block';
      document.getElementById('orders-list').style.display = 'none';
      document.getElementById('analytics-section').style.display = 'none';
      document.getElementById('status').textContent = '';
      document.querySelector('.progress').style.display = 'flex'; // Показываем прогресс бар
      renderStep();
      updateProgress();
      document.getElementById('backBtn').style.visibility = 'hidden';
    }

    function renderStep() {
      const step = steps[currentStep];
      document.getElementById('stepTitle').textContent = step.title;
      document.getElementById('currentStep').innerHTML = step.render ? step.render() : '';
      document.getElementById('backBtn').style.visibility = currentStep > 0 ? 'visible' : 'hidden';

      // Автофокус с задержкой
      const input = document.querySelector('input[autofocus]');
      if (input) {
        setTimeout(() => input.focus(), 300);
      }
    }

    function updateProgress() {
      const percent = ((currentStep + 1) / steps.length) * 100;
      document.getElementById('progressBar').style.width = percent + '%';
    }

    function goBack() {
      if (currentStep > 0) {
        currentStep--;
        renderStep();
        updateProgress();
      } else if (currentStatusView) {
        showStatusSelection();
      }
    }

    window.selectValue = function(field, value) {
      orderData[field] = value;
      currentStep++;
      renderStep();
      updateProgress();
    };

    window.nextStep = function() {
      const step = steps[currentStep];
      if (step.save) step.save();

      currentStep++;
      renderStep();
      updateProgress();
    };

    window.addOrderToSheets = async function() {
      const status = document.getElementById('status');
      status.textContent = `Добавление ${quantity} строк...`;
      const confirmCard = document.querySelector('.card[onclick="addOrderToSheets()"]');
      if (confirmCard) confirmCard.style.pointerEvents = 'none';

      try {
        const price = parseFloat(orderData.price) || 0;
        const singleSum = price.toFixed(2);

        const rows = [];
        for (let i = 0; i < quantity; i++) {
          rows.push({
            Магазин: orderData.shop,
            'Номер заказа': orderData.orderNumber || '',
            Аккаунт: orderData.account,
            'Дата заказа': orderData.date,
            Позиция: orderData.position,
            'Адрес ПВЗ': orderData.pvz,
            Статус: 'В пути',
            Оплата: orderData.payment,
            'Цена товара': price,
            Количество: 1,
            Сумма: singleSum,
          });
        }

        const res = await fetch('/api/add-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            initData: tg.initData,
            rows
          })
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Сервер: ${res.status} — ${errText}`);
        }

        status.textContent = `Успешно добавлено ${quantity} строк!`;
        document.getElementById('add-form').style.display = 'none';
        setTimeout(() => { status.textContent = ''; }, 5000);
        showStatusSelection();
      } catch (err) {
        console.error(err);
        status.textContent = 'Ошибка: ' + err.message;
      } finally {
        if (confirmCard) confirmCard.style.pointerEvents = 'auto';
      }
    };

    window.toggleOrders = function() {
      const list = document.getElementById('orders-list');
      const analytics = document.getElementById('analytics-section');
      analytics.style.display = 'none';
      list.style.display = list.style.display === 'block' ? 'none' : 'block';
      document.getElementById('add-form').style.display = 'none';
      document.querySelector('.progress').style.display = 'none'; // Скрываем прогресс бар
      
      if (list.style.display === 'block') {
        showStatusSelection();
      }
    };

    window.toggleAnalytics = function() {
      const analytics = document.getElementById('analytics-section');
      const list = document.getElementById('orders-list');
      list.style.display = 'none';
      document.getElementById('add-form').style.display = 'none';
      document.querySelector('.progress').style.display = 'none'; // Скрываем прогресс бар
      analytics.style.display = analytics.style.display === 'block' ? 'none' : 'block';
      
      if (analytics.style.display === 'block') {
        getAnalytics();
      }
    };

    window.showStatusDetails = function(status) {
      currentStatusView = status;
      const statusSelection = document.getElementById('status-selection');
      const statusDetails = document.getElementById('status-details');
      statusSelection.style.display = 'none';
      statusDetails.style.display = 'block';
      document.getElementById('backBtn').style.visibility = 'visible';

      // Показываем спиннер загрузки
      statusDetails.innerHTML = `
        <div class="step-title">${status}</div>
        <div class="loading-spinner">
          <div class="spinner"></div>Загрузка...
        </div>
      `;

      // Используем setTimeout для асинхронной отрисовки без блокировки UI
      setTimeout(() => {
        renderStatusDetails(status);
      }, 10);
    };

    function renderStatusDetails(status) {
      const statusDetails = document.getElementById('status-details');
      
      // Фильтруем заказы по выбранному статусу
      const filteredOrders = allOrders.filter(order => 
        (order['Статус'] || 'Без статуса') === status
      );

      if (filteredOrders.length === 0) {
        statusDetails.innerHTML = `
          <div class="step-title">${status}</div>
          <p style="text-align:center; color:var(--hint); padding:20px;">
            Нет заказов с этим статусом
          </p>
        `;
        return;
      }

      let html = `<div class="step-title">${status}</div>`;
      
      // Определяем, нужно ли группировать по ПВЗ
      const shouldGroupByPvz = status.toLowerCase().includes('пвз') || status.toLowerCase().includes('в пути');
      
      if (shouldGroupByPvz) {
        // Для ПВЗ и "В пути" группируем по адресу ПВЗ
        const pvzGroups = {};
        const allPvzAddresses = new Set();
        
        // Сначала собираем все уникальные адреса ПВЗ
        allOrders.forEach(order => {
          if (order['Адрес ПВЗ']) {
            allPvzAddresses.add(order['Адрес ПВЗ']);
          }
        });
        
        // Группируем заказы по ПВЗ и оплате
        filteredOrders.forEach(order => {
          const pvz = order['Адрес ПВЗ'] || 'Не указан';
          const position = order['Позиция'] || 'Не указано';
          const quantity = parseInt(order['Количество']) || 1;
          const sum = parseFloat(order['Сумма']) || 0;
          const payment = order['Оплата'] || 'Не указано';
          const isPaid = payment.toLowerCase().includes('оплачен');
          
          if (!pvzGroups[pvz]) {
            pvzGroups[pvz] = {
              paid: {},
              unpaid: {}
            };
          }
          
          const paymentGroup = isPaid ? pvzGroups[pvz].paid : pvzGroups[pvz].unpaid;
          
          if (!paymentGroup[position]) {
            paymentGroup[position] = {
              count: 0,
              totalSum: 0
            };
          }
          
          paymentGroup[position].count += quantity;
          paymentGroup[position].totalSum += sum;
        });

        // Общие суммы для всего статуса
        let totalItemsAll = 0;
        let totalAmountAll = 0;
        let totalPaidItemsAll = 0;
        let totalPaidAmountAll = 0;
        let totalUnpaidItemsAll = 0;
        let totalUnpaidAmountAll = 0;

        Object.values(pvzGroups).forEach(groups => {
          const paidItems = Object.entries(groups.paid);
          const unpaidItems = Object.entries(groups.unpaid);
          
          paidItems.forEach(([_, data]) => {
            totalItemsAll += data.count;
            totalAmountAll += data.totalSum;
            totalPaidItemsAll += data.count;
            totalPaidAmountAll += data.totalSum;
          });
          
          unpaidItems.forEach(([_, data]) => {
            totalItemsAll += data.count;
            totalAmountAll += data.totalSum;
            totalUnpaidItemsAll += data.count;
            totalUnpaidAmountAll += data.totalSum;
          });
        });

        // Общая статистика по статусу
        html += `
          <div class="table-total">
            Всего: ${totalItemsAll} шт. на сумму ${totalAmountAll.toLocaleString('ru-RU')} ₽<br>
            Оплачено: ${totalPaidItemsAll} шт. на сумму ${totalPaidAmountAll.toLocaleString('ru-RU')} ₽<br>
            Не оплачено: ${totalUnpaidItemsAll} шт. на сумму ${totalUnpaidAmountAll.toLocaleString('ru-RU')} ₽
          </div>
        `;

        // Создаем таблицы для каждого ПВЗ
        let hasItems = false;
        Object.entries(pvzGroups).forEach(([pvz, groups]) => {
          const paidItems = Object.entries(groups.paid);
          const unpaidItems = Object.entries(groups.unpaid);
          const totalPaidItems = paidItems.reduce((sum, [_, data]) => sum + data.count, 0);
          const totalUnpaidItems = unpaidItems.reduce((sum, [_, data]) => sum + data.count, 0);
          const totalPaidSum = paidItems.reduce((sum, [_, data]) => sum + data.totalSum, 0);
          const totalUnpaidSum = unpaidItems.reduce((sum, [_, data]) => sum + data.totalSum, 0);
          
          // Показываем ПВЗ только если есть товары
          if (totalPaidItems > 0 || totalUnpaidItems > 0) {
            hasItems = true;
            html += `
              <div class="pvz-table-container">
                <div class="pvz-header">
                  <span>${pvz}</span>
                  <span>${totalPaidItems + totalUnpaidItems} шт.</span>
                </div>
                <div class="pvz-total">
                  Всего: ${totalPaidItems + totalUnpaidItems} шт. на сумму ${(totalPaidSum + totalUnpaidSum).toLocaleString('ru-RU')} ₽
                </div>
            `;
            
            // Оплаченные товары
            if (totalPaidItems > 0) {
              html += `
                <div class="payment-section payment-paid">
                  <div class="payment-header">
                    <span>Оплаченные</span>
                    <span>${totalPaidItems} шт. • ${totalPaidSum.toLocaleString('ru-RU')} ₽</span>
                  </div>
              `;
              
              paidItems.forEach(([position, data]) => {
                html += `
                  <div class="table-row">
                    <div class="table-cell table-cell-name">${position}</div>
                    <div class="table-cell table-cell-count">${data.count} шт.</div>
                    <div class="table-cell table-cell-amount">${data.totalSum.toLocaleString('ru-RU')} ₽</div>
                  </div>
                `;
              });
              
              html += `</div>`;
            }
            
            // Неоплаченные товары
            if (totalUnpaidItems > 0) {
              html += `
                <div class="payment-section payment-unpaid">
                  <div class="payment-header">
                    <span>Неоплаченные</span>
                    <span>${totalUnpaidItems} шт. • ${totalUnpaidSum.toLocaleString('ru-RU')} ₽</span>
                  </div>
              `;
              
              unpaidItems.forEach(([position, data]) => {
                html += `
                  <div class="table-row">
                    <div class="table-cell table-cell-name">${position}</div>
                    <div class="table-cell table-cell-count">${data.count} шт.</div>
                    <div class="table-cell table-cell-amount">${data.totalSum.toLocaleString('ru-RU')} ₽</div>
                  </div>
                `;
              });
              
              html += `</div>`;
            }
            
            html += `</div>`;
          }
        });

        // Если нет товаров в этом статусе на ПВЗ
        if (!hasItems) {
          html += `<p style="text-align:center; color:var(--hint); padding:20px;">Нет товаров в этом статусе</p>`;
        }

      } else {
        // Для других статусов группируем просто по позициям
        const positionGroups = {};
        
        filteredOrders.forEach(order => {
          const position = order['Позиция'] || 'Не указано';
          const quantity = parseInt(order['Количество']) || 1;
          const sum = parseFloat(order['Сумма']) || 0;
          
          if (!positionGroups[position]) {
            positionGroups[position] = {
              count: 0,
              totalSum: 0
            };
          }
          
          positionGroups[position].count += quantity;
          positionGroups[position].totalSum += sum;
        });

        // Показываем общую статистику
        const totalItems = Object.values(positionGroups).reduce((sum, data) => sum + data.count, 0);
        const totalAmount = Object.values(positionGroups).reduce((sum, data) => sum + data.totalSum, 0);
        
        html += `
          <div class="table-total">
            Всего: ${totalItems} шт. на сумму ${totalAmount.toLocaleString('ru-RU')} ₽
          </div>
        `;

        // Создаем таблицу
        html += `<div class="table-container">`;
        
        Object.entries(positionGroups).forEach(([position, data]) => {
          html += `
            <div class="table-row">
              <div class="table-cell table-cell-name">${position}</div>
              <div class="table-cell table-cell-count">${data.count} шт.</div>
              <div class="table-cell table-cell-amount">${data.totalSum.toLocaleString('ru-RU')} ₽</div>
            </div>
          `;
        });
        
        html += `</div>`;
      }

      statusDetails.innerHTML = html;
    }

    window.toggleAnalyticsDetails = function() {
      analyticsExpanded = !analyticsExpanded;
      
      const mainCard = document.getElementById('analytics-main-card');
      const details = document.getElementById('analytics-details');
      const arrow = document.getElementById('analytics-arrow');
      
      if (analyticsExpanded) {
        mainCard.classList.add('expanded');
        details.classList.add('expanded');
        arrow.classList.add('expanded');
      } else {
        mainCard.classList.remove('expanded');
        details.classList.remove('expanded');
        arrow.classList.remove('expanded');
      }
    };

    async function showStatusSelection() {
      const statusSelection = document.getElementById('status-selection');
      const statusDetails = document.getElementById('status-details');
      statusSelection.style.display = 'block';
      statusDetails.style.display = 'none';
      statusSelection.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>Загрузка...
        </div>
      `;
      document.getElementById('backBtn').style.visibility = 'hidden';

      // Если данные уже загружены, используем кэш
      if (Object.keys(statusGroupsCache).length > 0) {
        renderStatusSelectionFromCache();
        return;
      }

      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: tg.initData })
        });

        if (!res.ok) throw new Error('Ошибка загрузки');

        const data = await res.json();
        allOrders = data.orders || [];

        if (!allOrders || allOrders.length === 0) {
          statusSelection.innerHTML = '<p style="text-align:center; color:var(--hint);">Заказов пока нет</p>';
          return;
        }

        // Группируем заказы по статусам и кэшируем
        const statusGroups = {};
        allOrders.forEach(order => {
          const status = order['Статус'] || 'Без статуса';
          if (!statusGroups[status]) {
            statusGroups[status] = [];
          }
          statusGroups[status].push(order);
        });
        
        // Сохраняем в кэш
        statusGroupsCache = statusGroups;
        
        // Отображаем из кэша
        renderStatusSelectionFromCache();

      } catch (err) {
        statusSelection.innerHTML = '<p style="color:red; text-align:center;">Ошибка загрузки</p>';
      }
    }

    function renderStatusSelectionFromCache() {
      const statusSelection = document.getElementById('status-selection');
      
      if (Object.keys(statusGroupsCache).length === 0) {
        statusSelection.innerHTML = '<p style="text-align:center; color:var(--hint);">Заказов пока нет</p>';
        return;
      }

      let html = '<div class="step-title">Выберите статус</div>';
      
      // Создаем карточки для каждого статуса из кэша
      Object.entries(statusGroupsCache).forEach(([status, orders]) => {
        const count = orders.length;
        html += `
          <div class="card status-card" onclick="showStatusDetails('${status}')">
            <div>${status}</div>
            <div class="status-count">${count}</div>
          </div>
        `;
      });

      statusSelection.innerHTML = html;
    }

    async function getAnalytics() {
      const analyticsContent = document.getElementById('analytics-content');
      analyticsContent.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>Загрузка аналитики...
        </div>
      `;

      try {
        const res = await fetch('/api/analytics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: tg.initData })
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('Ошибка сервера:', res.status, errorText);
          throw new Error(`Ошибка ${res.status}: ${errorText}`);
        }

        const data = await res.json();
        console.log('Данные аналитики:', data);

        // Проверяем, что все нужные поля присутствуют
        if (data.inTransitPaid === undefined || data.inPvzPaid === undefined || 
            data.receivedTotal === undefined || data.sentTotal === undefined || 
            data.marketWarehouseTotal === undefined || data.totalAmount === undefined) {
          throw new Error('Неполные данные от сервера');
        }

        // Создаем HTML для аналитики с выезжающими деталями
        const analyticsHTML = `
          <div class="analytics-main-card" id="analytics-main-card" onclick="toggleAnalyticsDetails()">
            <div class="analytics-main-title">
              Всего денег в товаре
              <span class="arrow-icon" id="analytics-arrow">▼</span>
            </div>
            <div class="analytics-main-amount">${data.totalAmount} ₽</div>
            <div class="analytics-main-subtitle">Нажмите для детализации</div>
          </div>
          <div class="analytics-details" id="analytics-details">
            <div class="analytics-item">
              <span class="analytics-label">В пути (оплаченные):</span>
              <span class="analytics-value">${data.inTransitPaid} ₽</span>
            </div>
            <div class="analytics-item">
              <span class="analytics-label">В ПВЗ (оплаченные):</span>
              <span class="analytics-value">${data.inPvzPaid} ₽</span>
            </div>
            <div class="analytics-item">
              <span class="analytics-label">Полученные:</span>
              <span class="analytics-value">${data.receivedTotal} ₽</span>
            </div>
            <div class="analytics-item">
              <span class="analytics-label">Отправленные:</span>
              <span class="analytics-value">${data.sentTotal} ₽</span>
            </div>
            <div class="analytics-item">
              <span class="analytics-label">На складе Маркета:</span>
              <span class="analytics-value">${data.marketWarehouseTotal} ₽</span>
            </div>
            <div style="margin-top: 20px; color: var(--hint); font-size: 14px; text-align: center;">
              * Учитываются только соответствующие статусы
            </div>
          </div>
        `;

        analyticsContent.innerHTML = analyticsHTML;
        analyticsExpanded = false;

      } catch (err) {
        console.error('Ошибка загрузки аналитики:', err);
        analyticsContent.innerHTML = `
          <p style="color:red; text-align:center; padding:20px;">
            Ошибка загрузки аналитики<br>
            <small>${err.message}</small>
          </p>
        `;
      }
    }
  </script>
</body>
</html>
