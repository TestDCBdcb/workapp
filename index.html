<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Заказы</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #888888;
      --tg-theme-button-color: #0088cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-section-bg-color: #f5f5f5;
      --wb-color: #7b2cbf;
      --ozon-color: #005bff;
      --avito-color: #00cc66;
      --ym-color: #ffcc00;
      --aliexpress-color: #ff6600;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --tg-theme-bg-color: #0f1621;
        --tg-theme-text-color: #e0e0e0;
        --tg-theme-hint-color: #9ca3af;
        --tg-theme-section-bg-color: #1a2332;
      }
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      min-height: 100vh;
    }

    .container { max-width: 900px; margin: 0 auto; }
    h1 { margin: 0 0 16px; font-size: 24px; }
    .greeting { margin-bottom: 20px; color: var(--tg-theme-hint-color); }

    .step-title {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .choice-btn {
      padding: 14px 20px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--tg-theme-section-bg-color);
      color: var(--tg-theme-text-color);
      transition: background 0.15s;
    }

    .choice-btn:hover { background: rgba(0,136,204,0.15); }
    .choice-btn.active { background: var(--tg-theme-button-color); color: white; }

    .color-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      background: var(--tg-theme-section-bg-color);
      color: var(--tg-theme-text-color);
    }

    #status {
      margin: 16px 0;
      color: var(--tg-theme-hint-color);
      font-size: 14px;
    }

    #orders-list { margin-top: 32px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Мои заказы</h1>
    <div class="greeting">Привет, <span id="user">загружаю...</span>!</div>

    <button class="choice-btn" onclick="startAddOrder()" style="width:100%; margin-bottom:24px;">
      ➕ Добавить новый заказ
    </button>

    <div id="add-form" style="display:none;">
      <div class="step-title" id="step-title">Шаг 1</div>
      <div id="current-step"></div>
      <button id="next-btn" onclick="nextStep()" style="margin-top:16px; width:100%;">Далее</button>
      <div id="status"></div>
    </div>

    <button onclick="getOrders()" id="load-btn" style="margin-top:32px; width:100%;">Обновить список заказов</button>
    <div id="orders-list"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    document.getElementById('user').textContent = tg.initDataUnsafe?.user?.first_name || 'пользователь';

    function applyTheme() {
      document.body.style.background = tg.backgroundColor;
      document.body.style.color = tg.textColor;
    }
    applyTheme();
    tg.onEvent('themeChanged', applyTheme);

    let orderData = {};
    let currentStep = 0;
    let quantity = 1;

    const steps = [
      {
        title: 'Магазин',
        render: () => {
          const shops = [
            { name: 'Wildberries', color: 'var(--wb-color)' },
            { name: 'Ozon', color: 'var(--ozon-color)' },
            { name: 'Avito', color: 'var(--avito-color)' },
            { name: 'Яндекс Маркет', color: 'var(--ym-color)' },
            { name: 'Aliexpress', color: 'var(--aliexpress-color)' },
            { name: 'Другое', color: '#888888' }
          ];
          let html = '<div class="button-group">';
          shops.forEach(s => {
            html += `
              <button class="choice-btn ${orderData.shop === s.name ? 'active' : ''}" 
                      onclick="selectShop('${s.name}')">
                <div class="color-dot" style="background:${s.color}"></div>
                ${s.name}
              </button>`;
          });
          html += '</div>';
          return html;
        },
        validate: () => !!orderData.shop
      },

      {
        title: 'Номер заказа',
        render: () => {
          if (orderData.shop === 'Wildberries') {
            orderData.orderNumber = '';
            return '<p style="color:#888;">Для Wildberries не нужен</p>';
          }
          return `<input type="text" id="order-num" placeholder="Номер заказа" value="${orderData.orderNumber || ''}">`;
        },
        validate: () => orderData.shop === 'Wildberries' || !!document.getElementById('order-num')?.value.trim(),
        save: () => {
          if (orderData.shop !== 'Wildberries') {
            orderData.orderNumber = document.getElementById('order-num')?.value.trim() || '';
          }
        }
      },

      {
        title: 'Аккаунт',
        render: () => {
          const accs = ['Артем','Лиза','Роберт','Максим','Мама','Миша','Кунак','Другое'];
          let html = '<div class="button-group">';
          accs.forEach(a => {
            html += `
              <button class="choice-btn ${orderData.account === a ? 'active' : ''}" 
                      onclick="selectAccount('${a}')">${a}</button>`;
          });
          html += '</div>';
          if (orderData.account === 'Другое') {
            html += `<input type="text" id="acc-other" placeholder="Введите аккаунт" value="${orderData.accountOther || ''}" style="margin-top:12px;">`;
          }
          return html;
        },
        validate: () => !!orderData.account && (orderData.account !== 'Другое' || !!orderData.accountOther),
        save: () => {
          if (orderData.account === 'Другое') {
            orderData.account = document.getElementById('acc-other')?.value.trim() || 'Другое';
          }
        }
      },

      {
        title: 'Дата заказа',
        render: () => {
          const today = new Date().toISOString().split('T')[0];
          const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
          let html = '<div class="button-group">';
          html += `<button class="choice-btn ${orderData.date === today ? 'active' : ''}" onclick="selectDate('${today}')">Сегодня</button>`;
          html += `<button class="choice-btn ${orderData.date === yesterday ? 'active' : ''}" onclick="selectDate('${yesterday}')">Вчера</button>`;
          html += `<button class="choice-btn ${orderData.date === 'other' ? 'active' : ''}" onclick="selectDate('other')">Другое</button>`;
          html += '</div>';
          if (orderData.date === 'other') {
            html += `<input type="date" id="date-other" value="${orderData.dateOther || today}">`;
          }
          return html;
        },
        validate: () => !!orderData.date && (orderData.date !== 'other' || !!orderData.dateOther),
        save: () => {
          if (orderData.date === 'other') {
            orderData.date = document.getElementById('date-other')?.value || new Date().toISOString().split('T')[0];
          }
        }
      },

      {
        title: 'Позиция (товар)',
        render: () => `<input type="text" id="position" placeholder="Название товара" value="${orderData.position || ''}">`,
        validate: () => !!document.getElementById('position')?.value.trim(),
        save: () => orderData.position = document.getElementById('position').value.trim()
      },

      {
        title: 'Адрес ПВЗ',
        render: () => {
          let addrs = [];
          if (orderData.shop === 'Wildberries') {
            addrs = [
              '1 Грайвороновский проезд 3',
              'Проспект Буденного 51к1',
              'Красноказарменная 15к1',
              'Профсоюзная 96',
              'Люблинская 51',
              'Севастопольский проспект 7/6к1',
              'Другое'
            ];
          } else if (orderData.shop === 'Ozon') {
            addrs = ['Пролетарский 2А', 'Другое'];
          } else {
            addrs = ['Другое'];
          }

          let html = '<div class="button-group">';
          addrs.forEach(a => {
            html += `
              <button class="choice-btn ${orderData.pvz === a ? 'active' : ''}" 
                      onclick="selectPvz('${a}')">${a}</button>`;
          });
          html += '</div>';
          if (orderData.pvz === 'Другое') {
            html += `<input type="text" id="pvz-other" placeholder="Введите адрес" value="${orderData.pvzOther || ''}" style="margin-top:12px;">`;
          }
          return html;
        },
        validate: () => !!orderData.pvz && (orderData.pvz !== 'Другое' || !!orderData.pvzOther),
        save: () => {
          if (orderData.pvz === 'Другое') {
            orderData.pvz = document.getElementById('pvz-other')?.value.trim() || 'Другое';
          }
        }
      },

      {
        title: 'Оплата',
        render: () => {
          const opts = ['Оплачен', 'При получении'];
          let html = '<div class="button-group">';
          opts.forEach(o => {
            html += `<button class="choice-btn ${orderData.payment === o ? 'active' : ''}" onclick="selectPayment('${o}')">${o}</button>`;
          });
          html += '</div>';
          return html;
        },
        validate: () => !!orderData.payment,
        save: () => {}
      },

      {
        title: 'Цена за 1 шт (₽)',
        render: () => `<input type="number" id="price" min="1" step="0.01" placeholder="Цена" value="${orderData.price || ''}">`,
        validate: () => {
          const v = parseFloat(document.getElementById('price')?.value);
          return !isNaN(v) && v > 0;
        },
        save: () => orderData.price = parseFloat(document.getElementById('price').value)
      },

      {
        title: 'Количество штук',
        render: () => `<input type="number" id="quantity" min="1" placeholder="Количество" value="${quantity}">`,
        validate: () => {
          const v = parseInt(document.getElementById('quantity')?.value);
          return !isNaN(v) && v >= 1;
        },
        save: () => quantity = parseInt(document.getElementById('quantity').value)
      },

      {
        title: 'Подтверждение',
        render: () => `
          <p><b>Магазин:</b> ${orderData.shop}</p>
          <p><b>Аккаунт:</b> ${orderData.account}</p>
          <p><b>Дата:</b> ${orderData.date}</p>
          <p><b>Товар:</b> ${orderData.position}</p>
          <p><b>ПВЗ:</b> ${orderData.pvz}</p>
          <p><b>Оплата:</b> ${orderData.payment}</p>
          <p><b>Цена за шт:</b> ${orderData.price} ₽</p>
          <p><b>Количество:</b> ${quantity} шт</p>
          <p><b>Итого сумма:</b> ${(orderData.price * quantity).toFixed(2)} ₽</p>
        `,
        validate: () => true,
        isConfirm: true
      }
    ];

    function startAddOrder() {
      orderData = {};
      currentStep = 0;
      quantity = 1;
      document.getElementById('add-form').style.display = 'block';
      renderCurrentStep();
    }

    function renderCurrentStep() {
      const step = steps[currentStep];
      document.getElementById('step-title').textContent = step.title;
      document.getElementById('current-step').innerHTML = step.render();

      const nextBtn = document.getElementById('next-btn');
      nextBtn.textContent = currentStep === steps.length - 1 ? 'Добавить в таблицу' : 'Далее';
    }

    window.selectShop = function(name) { orderData.shop = name; renderCurrentStep(); };
    window.selectAccount = function(acc) { orderData.account = acc; renderCurrentStep(); };
    window.selectDate = function(d) { orderData.date = d; renderCurrentStep(); };
    window.selectPvz = function(a) { orderData.pvz = a; renderCurrentStep(); };
    window.selectPayment = function(o) { orderData.payment = o; renderCurrentStep(); };

    function nextStep() {
      const step = steps[currentStep];
      if (step.save) step.save();

      if (!step.validate()) {
        document.getElementById('status').textContent = 'Заполните корректно';
        return;
      }

      document.getElementById('status').textContent = '';

      if (currentStep < steps.length - 1) {
        currentStep++;
        renderCurrentStep();
      } else {
        addOrderToSheets();
      }
    }

    async function addOrderToSheets() {
      const status = document.getElementById('status');
      status.textContent = `Добавление ${quantity} строк...`;
      document.getElementById('next-btn').disabled = true;

      try {
        const price = parseFloat(orderData.price);
        const fullSum = (price * quantity).toFixed(2);

        for (let i = 0; i < quantity; i++) {
          const row = {
            Магазин: orderData.shop,
            'Номер заказа': orderData.orderNumber || '',
            Аккаунт: orderData.account,
            'Дата заказа': orderData.date,
            Позиция: orderData.position,
            'Адрес ПВЗ': orderData.pvz,
            Статус: 'В пути',
            Оплата: orderData.payment,
            'Цена товара': price,
            Количество: 1,
            Сумма: i === 0 ? fullSum : price.toFixed(2),
          };

          const res = await fetch('/api/add-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              initData: tg.initData,
              data: row
            })
          });

          if (!res.ok) {
            throw new Error(`Ошибка на строке ${i+1}: ${res.status}`);
          }
        }

        status.textContent = `Успешно добавлено ${quantity} строк!`;
        document.getElementById('add-form').style.display = 'none';
        getOrders(); // обновляем список
      } catch (err) {
        console.error(err);
        status.textContent = 'Ошибка: ' + err.message;
      } finally {
        document.getElementById('next-btn').disabled = false;
      }
    }

    // Функция загрузки заказов (вставь сюда свой актуальный код getOrders из предыдущей версии)
    async function getOrders() {
      // ... твой код getOrders ...
      // если нужно — могу дать его заново
    }
  </script>
</body>
</html>
